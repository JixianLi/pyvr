# Phase 2: Add Automated Tests

## Scope

Create comprehensive automated tests for the new 3-column layout. Add new test file for layout-specific tests and update existing integration tests to ensure backward compatibility.

## Implementation

### Task 1: Create layout verification tests

**File:** `tests/test_interface/test_layout.py` (new file)

**Content:**

```python
"""Tests for interface layout configuration."""

import pytest
from unittest.mock import MagicMock, patch
import numpy as np

from pyvr.interface.matplotlib_interface import InteractiveVolumeRenderer
from pyvr.volume import Volume


@pytest.fixture
def mock_volume():
    """Create mock volume for testing."""
    data = np.random.rand(32, 32, 32).astype(np.float32)
    return Volume(data=data)


@pytest.fixture
def mock_renderer_context():
    """Mock OpenGL context and renderer components."""
    with patch('pyvr.interface.matplotlib_interface.VolumeRenderer') as mock_vr, \
         patch('matplotlib.pyplot.show'):  # Prevent window from opening

        # Mock renderer instance
        mock_renderer_instance = MagicMock()
        mock_renderer_instance.render_to_pil.return_value = MagicMock()
        mock_renderer_instance.get_light.return_value = MagicMock(is_linked=False)
        mock_vr.return_value = mock_renderer_instance

        yield mock_vr, mock_renderer_instance


def test_create_layout_returns_correct_structure(mock_volume, mock_renderer_context):
    """Test that _create_layout returns figure and axes dict."""
    interface = InteractiveVolumeRenderer(volume=mock_volume)

    fig, axes = interface._create_layout()

    # Should return figure and dict
    assert fig is not None
    assert isinstance(axes, dict)

    # Should have exactly 5 axes
    assert len(axes) == 5

    # Should have correct keys
    expected_keys = {'image', 'opacity', 'color', 'preset', 'info'}
    assert set(axes.keys()) == expected_keys


def test_create_layout_figure_size(mock_volume, mock_renderer_context):
    """Test that figure has correct size (16, 8)."""
    interface = InteractiveVolumeRenderer(volume=mock_volume)

    fig, axes = interface._create_layout()

    # Check figure size
    figsize = fig.get_size_inches()
    assert figsize[0] == 16.0  # Width
    assert figsize[1] == 8.0   # Height


def test_create_layout_gridspec_dimensions(mock_volume, mock_renderer_context):
    """Test that GridSpec has correct dimensions (3 rows, 3 columns)."""
    interface = InteractiveVolumeRenderer(volume=mock_volume)

    fig, axes = interface._create_layout()

    # Get GridSpec from first axes
    ax = axes['image']
    gs = ax.get_gridspec()

    # Check dimensions
    assert gs.nrows == 3
    assert gs.ncols == 3


def test_create_layout_width_ratios(mock_volume, mock_renderer_context):
    """Test that GridSpec has correct width ratios [2.5, 1.0, 0.8]."""
    interface = InteractiveVolumeRenderer(volume=mock_volume)

    fig, axes = interface._create_layout()

    # Get GridSpec from first axes
    ax = axes['image']
    gs = ax.get_gridspec()

    # Check width ratios
    expected_width_ratios = [2.5, 1.0, 0.8]
    actual_width_ratios = gs.get_width_ratios()

    assert len(actual_width_ratios) == len(expected_width_ratios)
    for actual, expected in zip(actual_width_ratios, expected_width_ratios):
        assert abs(actual - expected) < 0.001


def test_create_layout_height_ratios(mock_volume, mock_renderer_context):
    """Test that GridSpec has correct height ratios [3, 1, 1]."""
    interface = InteractiveVolumeRenderer(volume=mock_volume)

    fig, axes = interface._create_layout()

    # Get GridSpec from first axes
    ax = axes['image']
    gs = ax.get_gridspec()

    # Check height ratios
    expected_height_ratios = [3, 1, 1]
    actual_height_ratios = gs.get_height_ratios()

    assert len(actual_height_ratios) == len(expected_height_ratios)
    for actual, expected in zip(actual_height_ratios, expected_height_ratios):
        assert abs(actual - expected) < 0.001


def test_create_layout_axes_positions(mock_volume, mock_renderer_context):
    """Test that axes are positioned in correct grid cells."""
    interface = InteractiveVolumeRenderer(volume=mock_volume)

    fig, axes = interface._create_layout()

    # Get subplot specs for each axes
    image_spec = axes['image'].get_subplotspec()
    opacity_spec = axes['opacity'].get_subplotspec()
    color_spec = axes['color'].get_subplotspec()
    preset_spec = axes['preset'].get_subplotspec()
    info_spec = axes['info'].get_subplotspec()

    # Image should span all rows, column 0
    assert image_spec.rowspan.start == 0
    assert image_spec.rowspan.stop == 3
    assert image_spec.colspan.start == 0
    assert image_spec.colspan.stop == 1

    # Opacity should be row 0, column 1
    assert opacity_spec.rowspan.start == 0
    assert opacity_spec.rowspan.stop == 1
    assert opacity_spec.colspan.start == 1
    assert opacity_spec.colspan.stop == 2

    # Color should be row 1, column 1
    assert color_spec.rowspan.start == 1
    assert color_spec.rowspan.stop == 2
    assert color_spec.colspan.start == 1
    assert color_spec.colspan.stop == 2

    # Preset should be row 2, column 1
    assert preset_spec.rowspan.start == 2
    assert preset_spec.rowspan.stop == 3
    assert preset_spec.colspan.start == 1
    assert preset_spec.colspan.stop == 2

    # Info should span all rows, column 2
    assert info_spec.rowspan.start == 0
    assert info_spec.rowspan.stop == 3
    assert info_spec.colspan.start == 2
    assert info_spec.colspan.stop == 3


def test_create_layout_all_axes_valid(mock_volume, mock_renderer_context):
    """Test that all returned axes are valid matplotlib Axes objects."""
    interface = InteractiveVolumeRenderer(volume=mock_volume)

    fig, axes = interface._create_layout()

    # All axes should be matplotlib Axes instances
    import matplotlib.axes
    for key, ax in axes.items():
        assert isinstance(ax, matplotlib.axes.Axes), f"axes['{key}'] is not a valid Axes object"
```

### Task 2: Update integration tests

**File:** `tests/test_interface/test_integration.py`

**Changes needed:**

1. Check if there are any hardcoded assumptions about layout dimensions
2. Update any tests that validate figure size or GridSpec structure
3. Ensure all integration tests pass with new layout

**Steps:**

1. Read the current integration test file:
```bash
cat tests/test_interface/test_integration.py
```

2. Identify tests that might be affected by layout changes:
   - Tests that check figure properties
   - Tests that verify widget positioning
   - Tests that interact with specific axes

3. Update any tests with hardcoded (14, 8) figure size expectations
4. Update any tests with 2-column or 4-row assumptions

### Task 3: Run full test suite

**Command:**
```bash
cd /Users/jixianli/projects/pyvr
/Users/jixianli/miniforge3/envs/pyvr/bin/pytest tests/test_interface/ -v
```

**Expected results:**
- All existing tests pass (should be ~80 interface tests)
- New layout tests pass (8 new tests added)
- No failures or errors
- Total interface tests: ~88

### Task 4: Run complete test suite

**Command:**
```bash
cd /Users/jixianli/projects/pyvr
/Users/jixianli/miniforge3/envs/pyvr/bin/pytest tests/ -v
```

**Expected results:**
- All 361+ tests pass
- No regressions in other modules
- Coverage remains at ~86% or higher

## Verification

### Step 1: Verify new test file structure

Check that test file is properly structured:
```bash
/Users/jixianli/miniforge3/envs/pyvr/bin/pytest tests/test_interface/test_layout.py -v --co
```

Should list 8 test functions:
- test_create_layout_returns_correct_structure
- test_create_layout_figure_size
- test_create_layout_gridspec_dimensions
- test_create_layout_width_ratios
- test_create_layout_height_ratios
- test_create_layout_axes_positions
- test_create_layout_all_axes_valid

### Step 2: Run layout tests individually

```bash
/Users/jixianli/miniforge3/envs/pyvr/bin/pytest tests/test_interface/test_layout.py::test_create_layout_figure_size -v
/Users/jixianli/miniforge3/envs/pyvr/bin/pytest tests/test_interface/test_layout.py::test_create_layout_gridspec_dimensions -v
/Users/jixianli/miniforge3/envs/pyvr/bin/pytest tests/test_interface/test_layout.py::test_create_layout_width_ratios -v
/Users/jixianli/miniforge3/envs/pyvr/bin/pytest tests/test_interface/test_layout.py::test_create_layout_height_ratios -v
```

All should pass.

### Step 3: Run integration tests

```bash
/Users/jixianli/miniforge3/envs/pyvr/bin/pytest tests/test_interface/test_integration.py -v
```

Should pass without modifications (unless hardcoded layout assumptions found).

### Step 4: Check test coverage

```bash
/Users/jixianli/miniforge3/envs/pyvr/bin/pytest tests/test_interface/test_layout.py --cov=pyvr.interface.matplotlib_interface --cov-report=term-missing
```

Should show coverage for `_create_layout()` method at 100%.

## Validation

### Comprehensive Test Suite Check

Run all tests with verbose output:
```bash
/Users/jixianli/miniforge3/envs/pyvr/bin/pytest tests/ -v --tb=short
```

**Expected:**
- Total tests: 369 (361 existing + 8 new)
- All pass
- No failures or skips (except known platform-specific skips)

### Edge Case Coverage

Verify tests cover:
- âœ“ Figure size validation
- âœ“ GridSpec dimensions (3x3)
- âœ“ Width ratios [2.5, 1.0, 0.8]
- âœ“ Height ratios [3, 1, 1]
- âœ“ Axes positioning in correct cells
- âœ“ All axes are valid matplotlib objects
- âœ“ Correct axes keys returned

### Regression Prevention

Tests should ensure:
- Layout changes don't break widget initialization
- Event handlers still bind correctly to axes
- State management unaffected by layout
- All existing functionality preserved

## Acceptance Criteria

- [ ] `tests/test_interface/test_layout.py` created with 8 tests
- [ ] All layout tests pass
- [ ] Integration tests reviewed and updated if needed
- [ ] Full interface test suite passes (~88 tests)
- [ ] Complete project test suite passes (369 tests)
- [ ] No test failures or regressions
- [ ] Test coverage for `_create_layout()` at 100%
- [ ] All new tests use proper mocking (no actual OpenGL calls)
- [ ] Tests verify all critical layout properties:
  - Figure size (16, 8)
  - GridSpec dimensions (3x3)
  - Width ratios [2.5, 1.0, 0.8]
  - Height ratios [3, 1, 1]
  - Axes positioning and span

## Git Commit

```bash
git add tests/test_interface/test_layout.py
git add tests/test_interface/test_integration.py  # Only if modified
git commit -m "$(cat <<'EOF'
test(interface): Add comprehensive layout tests for v0.3.2

Add test_layout.py with 8 tests verifying 3-column GridSpec:
- Figure size (16, 8)
- GridSpec dimensions (3 rows, 3 columns)
- Width ratios [2.5, 1.0, 0.8]
- Height ratios [3, 1, 1]
- Axes positioning in correct grid cells
- All axes valid matplotlib objects

All tests use proper mocking to avoid OpenGL dependencies.

Test count: 361 â†’ 369 tests
All tests passing.

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
```

## Notes

- Tests use mocking to avoid OpenGL context requirements
- Tests verify both structure and dimensions of layout
- Integration tests should not need changes (layout is internal detail)
- If integration tests fail, investigate for hardcoded layout assumptions
