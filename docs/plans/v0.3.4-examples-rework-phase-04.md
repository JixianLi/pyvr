# Phase 04: Create transfer_functions_demo.py

## Scope

Create transfer function demonstration showing different opacity patterns and colormaps.

**What will be built:**
- `example/transfer_functions_demo.py` - Transfer function configurations demo
- ~100 lines of heavily commented code
- 2Ã—2 grid showing 4 different transfer function combinations
- Small TF visualizations below each render

**Dependencies:**
- Phase 01 completed (clean example directory)
- Phase 02-03 completed (can reference structure)

**Files affected:**
- CREATE: `example/transfer_functions_demo.py`

## Implementation

### Task 1: Create file structure with headers and imports
**Action:** Create the file with ABOUTME headers, docstring, and imports.

**File:** `example/transfer_functions_demo.py`

**Content:**
```python
# ABOUTME: Transfer function demonstration with different opacity patterns and colormaps
# ABOUTME: Shows 4 TF combinations in 2x2 grid with visualization plots

"""
Transfer Functions Demonstration

This example demonstrates different transfer function configurations:
1. Linear opacity with viridis colormap
2. Peak opacity with plasma colormap
3. Gaussian opacity with coolwarm colormap
4. Custom opacity curve with jet colormap

Transfer functions control how volume data values map to colors and opacity,
allowing you to emphasize different features in the data.
"""

import numpy as np
import matplotlib.pyplot as plt
from matplotlib.gridspec import GridSpec

from pyvr.camera import Camera
from pyvr.config import RenderConfig
from pyvr.datasets import create_sample_volume, compute_normal_volume
from pyvr.lighting import Light
from pyvr.moderngl_renderer import VolumeRenderer
from pyvr.transferfunctions import ColorTransferFunction, OpacityTransferFunction
from pyvr.volume import Volume

# Rendering parameters
VOLUME_SIZE = 128  # Volume dimensions (128x128x128)
IMAGE_RES = 384    # Output resolution per view
LUT_SIZE = 256     # Transfer function lookup table size


def main():
    """Run the transfer functions demo."""
    print("Transfer Functions Demo")
    print("=" * 50)
```

### Task 2: Implement volume and renderer setup
**Action:** Add volume creation and renderer initialization.

**Content to add in main():**
```python
    # Step 1: Create volume with normals
    # Using torus dataset as it shows transfer function effects well
    print("Creating volume...")
    volume_data = create_sample_volume(VOLUME_SIZE, 'torus')
    normals = compute_normal_volume(volume_data)
    volume = Volume(
        data=volume_data,
        normals=normals,
        min_bounds=np.array([-1.0, -1.0, -1.0], dtype=np.float32),
        max_bounds=np.array([1.0, 1.0, 1.0], dtype=np.float32)
    )

    # Step 2: Create renderer with consistent settings
    print("Setting up renderer...")
    config = RenderConfig.balanced()
    light = Light.default()
    renderer = VolumeRenderer(
        width=IMAGE_RES,
        height=IMAGE_RES,
        config=config,
        light=light
    )
    renderer.load_volume(volume)

    # Use isometric view for all renders (good 3D perspective)
    camera = Camera.isometric_view(distance=3.0)
    renderer.set_camera(camera)
```

### Task 3: Define transfer function configurations
**Action:** Create list of different TF combinations to demonstrate.

**Content to add in main():**
```python
    # Step 3: Define different transfer function combinations
    print("Creating transfer functions...")

    # Configuration 1: Linear opacity with viridis
    # Simple linear ramp from transparent to semi-opaque
    tf_configs = [
        {
            'ctf': ColorTransferFunction.from_colormap('viridis'),
            'otf': OpacityTransferFunction.linear(0.0, 0.1),
            'title': 'Linear Opacity\\nViridis Colors'
        },

        # Configuration 2: Peak opacity with plasma
        # Highlights specific density values with opacity peaks
        {
            'ctf': ColorTransferFunction.from_colormap('plasma'),
            'otf': OpacityTransferFunction.peaks(
                peaks=[0.3, 0.7],  # Peak at 30% and 70% density
                opacity=0.3,        # Peak opacity value
                eps=0.05,           # Peak width
                base=0.0            # Base opacity elsewhere
            ),
            'title': 'Peak Opacity (0.3, 0.7)\\nPlasma Colors'
        },

        # Configuration 3: Gaussian opacity with coolwarm
        # Bell curve centered on mid-range values
        {
            'ctf': ColorTransferFunction.from_colormap('coolwarm'),
            'otf': OpacityTransferFunction.gaussian(
                center=0.5,    # Center of bell curve
                width=0.2,     # Standard deviation
                opacity=0.15   # Maximum opacity at center
            ),
            'title': 'Gaussian Opacity (Î¼=0.5)\\nCoolwarm Colors'
        },

        # Configuration 4: Custom opacity with jet
        # Manual control points for fine-tuned opacity
        {
            'ctf': ColorTransferFunction.from_colormap('jet'),
            'otf': OpacityTransferFunction.from_control_points(
                points=[(0.0, 0.0), (0.2, 0.05), (0.5, 0.15), (0.8, 0.05), (1.0, 0.0)]
            ),
            'title': 'Custom Curve\\nJet Colors'
        }
    ]
```

### Task 4: Implement rendering loop
**Action:** Add rendering for all TF configurations.

**Content to add in main():**
```python
    # Step 4: Render all configurations
    print(f"Rendering {len(tf_configs)} configurations...")

    results = []
    for idx, config in enumerate(tf_configs):
        # Set transfer functions for this configuration
        renderer.set_transfer_functions(config['ctf'], config['otf'])

        # Render
        data = renderer.render()
        image = np.frombuffer(data, dtype=np.uint8).reshape(
            (IMAGE_RES, IMAGE_RES, 4)
        )

        # Store result with TF data for visualization
        results.append({
            'image': image,
            'title': config['title'],
            'ctf': config['ctf'],
            'otf': config['otf']
        })

        print(f"  Rendered: {config['title'].split(chr(10))[0]}")  # First line of title
```

### Task 5: Implement display with TF visualizations
**Action:** Add matplotlib grid with renders and TF plots.

**Content to add in main():**
```python
    # Step 5: Display results in 2x2 grid with TF visualizations
    print("Creating visualization...")

    fig = plt.figure(figsize=(12, 10))
    # Grid: 2 rows of images, 2 rows of transfer function plots
    gs = GridSpec(4, 2, height_ratios=[2, 0.5, 2, 0.5], hspace=0.3, wspace=0.2)

    for idx, result in enumerate(results):
        row = (idx // 2) * 2  # 0 or 2 (skip TF rows)
        col = idx % 2

        # Render image
        ax_image = fig.add_subplot(gs[row, col])
        ax_image.imshow(result['image'], origin='lower')
        ax_image.set_title(result['title'], fontsize=10)
        ax_image.axis('off')

        # Transfer function plot
        ax_tf = fig.add_subplot(gs[row + 1, col])

        # Generate LUTs for visualization
        x = np.linspace(0, 1, LUT_SIZE)
        color_lut = result['ctf'].to_lut(LUT_SIZE)
        opacity_lut = result['otf'].to_lut(LUT_SIZE)

        # Show colormap as background
        ax_tf.imshow(
            color_lut[np.newaxis, :, :],
            aspect='auto',
            extent=[0, 1, 0, 1]
        )

        # Overlay opacity curve
        ax_tf.plot(x, opacity_lut, 'k-', linewidth=2, label='Opacity')
        ax_tf.set_xlim(0, 1)
        ax_tf.set_ylim(0, 1)
        ax_tf.set_xlabel('Data Value', fontsize=8)
        ax_tf.set_ylabel('Opacity', fontsize=8)
        ax_tf.tick_params(labelsize=7)

    plt.suptitle(
        'Transfer Function Configurations',
        fontsize=14,
        fontweight='bold'
    )
    plt.show()

    print("=" * 50)
    print("Demo complete!")
```

### Task 6: Add main guard
**Action:** Add standard Python main guard.

**Content to add:**
```python


if __name__ == "__main__":
    main()
```

## Verification

### Step 1: Verify file exists and syntax
```bash
# Check file exists
ls -la example/transfer_functions_demo.py

# Check syntax
python -m py_compile example/transfer_functions_demo.py
```

### Step 2: Run the example
```bash
python example/transfer_functions_demo.py
```

**Expected output:**
- Console prints progress messages
- Matplotlib window opens with 2Ã—2 grid
- Each subplot shows torus with different coloring/opacity
- TF plots below each render showing color and opacity curves

## Validation

### Visual Validation
- [ ] 2Ã—2 grid with 4 different renders
- [ ] Linear opacity shows gradual fade
- [ ] Peak opacity emphasizes specific densities
- [ ] Gaussian opacity highlights mid-range values
- [ ] Custom curve shows user-defined pattern
- [ ] TF plots accurately represent each configuration
- [ ] Colormap backgrounds match rendered colors

### Code Quality Checks
- [ ] ABOUTME headers present (2 lines)
- [ ] Docstring explains transfer function concepts
- [ ] Heavy inline comments throughout
- [ ] No version references or temporal language
- [ ] ~100 lines total (Â±15 lines acceptable)
- [ ] Demonstrates 4 different opacity patterns
- [ ] Shows 4 different colormaps

### Integration Testing
```bash
# Should run without errors
python example/transfer_functions_demo.py

# Should display 4 distinct TF configurations
```

## Acceptance Criteria

- [ ] `example/transfer_functions_demo.py` created
- [ ] File has ABOUTME headers (2 lines)
- [ ] File has complete docstring
- [ ] All imports correct and grouped
- [ ] Constants defined at module level
- [ ] Heavy inline comments explaining TF concepts
- [ ] No version references or temporal language
- [ ] Demonstrates linear opacity
- [ ] Demonstrates peak opacity
- [ ] Demonstrates gaussian opacity
- [ ] Demonstrates custom control points
- [ ] Shows 4 different colormaps (viridis, plasma, coolwarm, jet)
- [ ] Renders 4 views in 2Ã—2 grid
- [ ] TF visualizations below each render
- [ ] Example runs without errors
- [ ] Code is ~100 lines (Â±15 lines)

## Git Commit

**Commit message:**
```
feat(examples): Add transfer_functions_demo.py example

Transfer function demonstration showing:
- Linear opacity with viridis colormap
- Peak opacity with plasma colormap
- Gaussian opacity with coolwarm colormap
- Custom control points with jet colormap
- 2x2 grid with TF visualizations below each render

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

**Files to commit:**
- `example/transfer_functions_demo.py`

**Command:**
```bash
git add example/transfer_functions_demo.py
git commit -m "$(cat <<'EOF'
feat(examples): Add transfer_functions_demo.py example

Transfer function demonstration showing:
- Linear opacity with viridis colormap
- Peak opacity with plasma colormap
- Gaussian opacity with coolwarm colormap
- Custom control points with jet colormap
- 2x2 grid with TF visualizations below each render

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
```
