# Phase 1: Implement Layout Changes

## Scope

Modify the `_create_layout()` method in `matplotlib_interface.py` to implement the 3-column layout. This phase focuses solely on the core layout change without tests or documentation.

## Implementation

### Task 1: Modify `_create_layout()` method

**File:** `pyvr/interface/matplotlib_interface.py`

**Location:** Lines 208-242 (current `_create_layout()` method)

**Changes:**

1. Change figure size from (14, 8) to (16, 8):
```python
# Before:
fig = plt.figure(figsize=(14, 8))

# After:
fig = plt.figure(figsize=(16, 8))
```

2. Update GridSpec from 4x2 to 3x3 with new ratios:
```python
# Before:
gs = GridSpec(4, 2, figure=fig,
             width_ratios=[2, 1],
             height_ratios=[4, 2, 2, 1],
             hspace=0.3, wspace=0.3)

# After:
# 3-column layout: image (2.5) | controls (1.0) | info (0.8)
# Info panel spans full height to display all text without truncation
gs = GridSpec(3, 3, figure=fig,
             width_ratios=[2.5, 1.0, 0.8],
             height_ratios=[3, 1, 1],
             hspace=0.3, wspace=0.3)
```

3. Update axes subplot assignments:
```python
# Before:
ax_image = fig.add_subplot(gs[:, 0])      # Full left column
ax_opacity = fig.add_subplot(gs[0, 1])    # Top right
ax_color = fig.add_subplot(gs[1, 1])      # Middle-top right
ax_preset = fig.add_subplot(gs[2, 1])     # Middle-bottom right
ax_info = fig.add_subplot(gs[3, 1])       # Bottom right

# After:
ax_image = fig.add_subplot(gs[:, 0])      # Full left column (all rows)
ax_opacity = fig.add_subplot(gs[0, 1])    # Top middle
ax_color = fig.add_subplot(gs[1, 1])      # Middle middle
ax_preset = fig.add_subplot(gs[2, 1])     # Bottom middle
ax_info = fig.add_subplot(gs[:, 2])       # Full right column (all rows)
```

4. Update method docstring:
```python
def _create_layout(self) -> tuple:
    """
    Create matplotlib figure layout.

    Uses 3-column layout:
    - Left (2.5): Image display (full height)
    - Middle (1.0): Stacked control widgets
    - Right (0.8): Info panel (full height)

    Returns:
        Tuple of (figure, axes_dict) with keys: 'image', 'opacity', 'color', 'preset', 'info'
    """
```

**Complete updated method:**
```python
def _create_layout(self) -> tuple:
    """
    Create matplotlib figure layout.

    Uses 3-column layout:
    - Left (2.5): Image display (full height)
    - Middle (1.0): Stacked control widgets
    - Right (0.8): Info panel (full height)

    Returns:
        Tuple of (figure, axes_dict) with keys: 'image', 'opacity', 'color', 'preset', 'info'
    """
    # Create figure
    fig = plt.figure(figsize=(16, 8))
    fig.suptitle("PyVR Interactive Volume Renderer", fontsize=14, fontweight='bold')

    # Create grid layout
    # 3-column layout: image (2.5) | controls (1.0) | info (0.8)
    # Info panel spans full height to display all text without truncation
    gs = GridSpec(3, 3, figure=fig,
                 width_ratios=[2.5, 1.0, 0.8],
                 height_ratios=[3, 1, 1],
                 hspace=0.3, wspace=0.3)

    # Create axes
    ax_image = fig.add_subplot(gs[:, 0])      # Full left column (all rows)
    ax_opacity = fig.add_subplot(gs[0, 1])    # Top middle
    ax_color = fig.add_subplot(gs[1, 1])      # Middle middle
    ax_preset = fig.add_subplot(gs[2, 1])     # Bottom middle
    ax_info = fig.add_subplot(gs[:, 2])       # Full right column (all rows)

    axes_dict = {
        'image': ax_image,
        'opacity': ax_opacity,
        'color': ax_color,
        'preset': ax_preset,
        'info': ax_info,
    }

    return fig, axes_dict
```

## Verification

### Step 1: Visual Inspection

Run the example interface to verify layout:

```bash
cd /Users/jixianli/projects/pyvr
/Users/jixianli/miniforge3/envs/pyvr/bin/python -c "
from pyvr.datasets import create_sample_volume
from pyvr.volume import Volume
from pyvr.interface import InteractiveVolumeRenderer

volume_data = create_sample_volume(128, 'sphere')
volume = Volume(data=volume_data)

interface = InteractiveVolumeRenderer(volume=volume, width=512, height=512)
interface.show()
"
```

**Expected Results:**
- Figure window opens at approximately 16x8 inches
- Three distinct columns visible:
  - Left: Large image display
  - Middle: Opacity editor (top), color selector (middle), preset selector (bottom)
  - Right: Info panel showing all controls and status text
- All interface text in info panel visible without truncation
- No overlapping widgets or text cutoff

### Step 2: Check Widget Functionality

Interact with the interface to verify all functionality intact:

1. **Image display:**
   - Drag to orbit camera - should work normally
   - Scroll to zoom - should work normally
   - FPS counter visible in top-left

2. **Opacity editor:**
   - Click to add control points - should work
   - Drag control points - should work
   - Right-click to remove - should work
   - Histogram background visible

3. **Color selector:**
   - Click dropdown to change colormap - should work
   - Colormap preview visible

4. **Preset selector:**
   - Click radio buttons to change quality - should work
   - All 5 presets visible

5. **Info panel:**
   - All text visible (mouse controls, keyboard shortcuts, status)
   - No scrolling required
   - Text readable at fontsize=8

6. **Keyboard shortcuts:**
   - Press 'f' to toggle FPS - should update status
   - Press 'h' to toggle histogram - should work
   - Press 'l' to toggle light link - should update status
   - Press 'q' to toggle auto-quality - should update status
   - Press 'r' to reset view - should work
   - Press 's' to save image - should work

### Step 3: Check for Layout Errors

Watch console for any matplotlib warnings or errors during:
- Interface launch
- Widget interaction
- Window resize (try resizing the window manually)

**Expected:** No errors or warnings related to GridSpec or subplot creation.

## Validation

### Integration Check

Verify that all existing functionality works with new layout:

1. **Camera controls remain responsive:**
   - No lag during drag operations
   - Zoom works smoothly
   - Auto-quality switches during interaction (if enabled)

2. **Transfer function editing works:**
   - Control point manipulation smooth
   - Volume re-renders correctly after changes
   - Color changes apply immediately

3. **State management intact:**
   - Settings persist during interaction
   - Status display updates correctly
   - Preset changes apply immediately

### Edge Case Testing

1. **Window resize:**
   - Resize matplotlib window to various sizes
   - Verify layout adapts without breaking
   - Check that text remains readable

2. **High DPI display (if available):**
   - Launch on high DPI display
   - Verify text is sharp and readable
   - Verify layout proportions maintained

3. **Different volume sizes:**
   - Test with small volume (64Â³)
   - Test with large volume (256Â³)
   - Verify layout unchanged regardless of data size

## Acceptance Criteria

- [ ] `_create_layout()` method updated with 3-column GridSpec
- [ ] Figure size changed to (16, 8)
- [ ] Width ratios set to [2.5, 1.0, 0.8]
- [ ] Height ratios set to [3, 1, 1]
- [ ] Axes assignments updated to use 3-column layout
- [ ] Inline comments added explaining layout structure
- [ ] Method docstring updated to describe 3-column layout
- [ ] Interface launches without errors
- [ ] All info panel text visible without truncation
- [ ] All widgets functional (image, opacity, color, preset, info)
- [ ] All mouse controls work (drag, scroll, click)
- [ ] All keyboard shortcuts work (r, s, f, h, l, q, Esc, Del)
- [ ] No matplotlib warnings or errors
- [ ] Window resize works without breaking layout

## Git Commit

```bash
git add pyvr/interface/matplotlib_interface.py
git commit -m "$(cat <<'EOF'
feat(interface): Implement 3-column layout for v0.3.2

Change layout from 2-column (4x2) to 3-column (3x3) GridSpec:
- Image display: left column (width 2.5)
- Control widgets: middle column (width 1.0)
- Info panel: right column (width 0.8, full height)

Figure size increased from (14, 8) to (16, 8) to accommodate
wider layout. Info panel now spans full height, displaying all
controls and status text without truncation.

Changes:
- Update _create_layout() with new GridSpec configuration
- Add inline comments explaining layout structure
- Update method docstring

No API changes - purely visual enhancement.

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
```

## Notes

- This phase contains ONLY the layout change - no tests or documentation
- All other code (widgets, event handlers, state management) remains unchanged
- No breaking changes - existing API fully compatible
- Manual testing is critical in this phase to catch visual issues early
