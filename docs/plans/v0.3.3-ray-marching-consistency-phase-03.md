# Phase 03: Documentation and Release

**Feature:** v0.3.3 Ray Marching Opacity Consistency
**Phase:** 03 of 03
**Focus:** Complete documentation, version notes, and release preparation

## Scope

Create comprehensive documentation for the opacity correction bug fix:
- Write detailed version notes with technical explanation
- Update README.md with opacity correction information
- Update CLAUDE.md with v0.3.3 version history
- Create migration guide for users affected by visual changes
- Document breaking changes with clear examples
- Update RenderConfig docstring (already done in Phase 01, verify completeness)

This phase prepares the feature for release with clear, user-friendly documentation.

## Implementation

### Task 1: Write Comprehensive Version Notes

**File:** `version_notes/v0.3.3_ray_marching_consistency.md` (NEW FILE)

**Create complete version notes document:**

```markdown
# v0.3.3 Ray Marching Opacity Consistency

**Release Date:** 2025-XX-XX (TBD)
**Type:** Bug Fix (Breaking Visual Change)

## Overview

Fixes critical bug where rendering quality presets produced visually inconsistent results. Implements Beer-Lambert law for physically correct opacity accumulation, ensuring all quality presets produce the same appearance regardless of step size.

**Impact:** Breaking visual change - high quality presets will render lighter, low quality presets darker. This is the physically correct behavior.

## The Problem

### What Was Wrong

The ray marching shader applied transfer function opacity directly without correcting for step size. This caused:

- **High quality presets** (smaller step sizes) took more samples per unit length
- Each sample contributed opacity from the transfer function
- Result: More samples = more opacity accumulation = darker, more opaque renders
- **Low quality presets** (larger step sizes) had the opposite problem - too transparent

Example with same transfer function:
- `preview` (step_size=0.05): Light, transparent appearance
- `balanced` (step_size=0.01): Medium opacity
- `ultra_quality` (step_size=0.001): Very dark, overly opaque

**This violated physical correctness**: The same volume with the same transfer function should look the same regardless of sampling quality.

### Technical Root Cause

The shader accumulated opacity without accounting for step size:

```glsl
// OLD (INCORRECT)
float alpha = rgba.a;  // Raw alpha from transfer function
accumulated_alpha += (1.0 - accumulated_alpha) * alpha;
```

The transfer function defines opacity at some implicit reference step size, but when rendering at different step sizes, the accumulated opacity varied incorrectly.

### Impact

- Users could not reliably switch between quality presets
- Transfer functions designed for one preset looked wrong at others
- Scientific visualization results were not reproducible
- Violated Beer-Lambert law for light absorption
- Made it impossible to use quality presets for their intended purpose (trading speed for smoothness while maintaining appearance)

## The Solution

### Beer-Lambert Opacity Correction

Implemented exponential opacity correction based on Beer-Lambert law:

```glsl
// NEW (CORRECT)
float alpha_tf = rgba.a;  // Raw alpha from transfer function
float alpha_step_size_corrected = 1.0 - exp(-alpha_tf * step_size / reference_step_size);
accumulated_alpha += (1.0 - accumulated_alpha) * alpha_step_size_corrected;
```

**Physical Basis:** Beer-Lambert law describes how light is absorbed through a medium:
```
I = Iâ‚€ * exp(-Ï„ * d)
```

Where:
- `I` = transmitted light intensity
- `Iâ‚€` = initial light intensity
- `Ï„` = extinction coefficient (opacity)
- `d` = distance traveled

**In Our Implementation:**
- `alpha_tf / reference_step_size` = extinction coefficient
- `step_size` = distance traveled per sample
- Correction ensures physically consistent accumulation

### New Parameter: reference_step_size

Added `reference_step_size` parameter to `RenderConfig`:

```python
@dataclass
class RenderConfig:
    step_size: float
    max_steps: int
    early_ray_termination: bool = True
    opacity_threshold: float = 0.95
    reference_step_size: float = 0.01  # NEW
```

**Default:** 0.01 (matches balanced preset step size)

**Purpose:** Defines the step size that transfer functions are "designed for". All other step sizes are corrected to match this reference.

### Result

After correction:
- All quality presets produce **visually identical** overall appearance
- Differences are only in **sampling smoothness**, not opacity/brightness
- Transfer functions work correctly at all presets
- Physically accurate, scientifically reproducible results

## Changes

### Core Implementation

**Files Modified:**
- `pyvr/config.py`: Added `reference_step_size` parameter with comprehensive docstring
- `pyvr/shaders/volume.frag.glsl`: Implemented Beer-Lambert opacity correction
- `pyvr/moderngl_renderer/renderer.py`: Pass `reference_step_size` uniform to shader

**Formula:**
```glsl
alpha_step_size_corrected = 1.0 - exp(-alpha_tf * step_size / reference_step_size)
```

### Tests Added

**New Test Files:**
- `tests/test_config_opacity_correction.py`: Unit tests for formula and parameter (20+ tests)
- `tests/test_moderngl_renderer/test_opacity_correction_integration.py`: Integration tests (10+ tests)
- `tests/visual_comparison_opacity_correction.py`: Visual validation tool

**Test Coverage:**
- Mathematical formula correctness
- Edge cases (alpha=0, alpha=1, extreme step sizes)
- Physical correctness (Beer-Lambert law)
- All presets render successfully
- Opacity consistency across presets
- No regression in existing functionality

**Test Count:** 368 â†’ 398 tests (all passing)

## Breaking Changes

### Visual Appearance Changes

**What Changes:**
- **High quality presets** (high_quality, ultra_quality) will render **lighter/less opaque** than before
- **Low quality presets** (preview, fast) will render **darker/more opaque** than before
- **Balanced preset** will look similar (reference_step_size = 0.01 matches balanced step_size)

**Why:**
- **Before:** Bug caused incorrect opacity accumulation based on sampling density
- **After:** Physically correct opacity accumulation across all presets

**Example Impact:**
```
Preset          Before v0.3.3    After v0.3.3
-------------------------------------------------
preview         Too light        Correct (darker)
fast            Light            Correct
balanced        Correct          Correct (unchanged)
high_quality    Too dark         Correct (lighter)
ultra_quality   Very dark        Correct (lighter)
```

### API Changes

**New Parameter:** `reference_step_size` in `RenderConfig`
- Default: 0.01
- All existing code works without changes (uses default)
- Optional: Can be customized per dataset

**No Other API Changes:** All existing methods, parameters, and interfaces remain unchanged.

## Migration Guide

### If Your Renders Look Too Light

If your renders appear too transparent/light after upgrading (likely with high_quality or ultra_quality presets):

**Option 1: Increase Transfer Function Opacity**

```python
# Before v0.3.3
otf = OpacityTransferFunction(control_points=[
    (0.0, 0.0),
    (0.5, 0.4),  # Original opacity
    (1.0, 1.0)
])

# After v0.3.3 - increase opacity values
otf = OpacityTransferFunction(control_points=[
    (0.0, 0.0),
    (0.5, 0.6),  # Increased from 0.4 to 0.6
    (1.0, 1.0)
])
```

**Option 2: Adjust reference_step_size**

```python
# Make reference smaller â†’ renders appear more opaque
config = RenderConfig.high_quality()
config = RenderConfig(
    step_size=config.step_size,
    max_steps=config.max_steps,
    reference_step_size=0.005  # Smaller than default 0.01
)
renderer = VolumeRenderer(config=config)
```

### If Your Renders Look Too Dark

If your renders appear too opaque/dark after upgrading (likely with preview or fast presets):

**Option 1: Decrease Transfer Function Opacity**

```python
# Before v0.3.3
otf = OpacityTransferFunction.linear(0.0, 0.5)

# After v0.3.3 - reduce max opacity
otf = OpacityTransferFunction.linear(0.0, 0.3)  # Reduced from 0.5 to 0.3
```

**Option 2: Adjust reference_step_size**

```python
# Make reference larger â†’ renders appear less opaque
config = RenderConfig.fast()
config = RenderConfig(
    step_size=config.step_size,
    max_steps=config.max_steps,
    reference_step_size=0.02  # Larger than default 0.01
)
renderer = VolumeRenderer(config=config)
```

### Recommended Migration Approach

1. **Re-design transfer functions at balanced preset**
   - Use `RenderConfig.balanced()` as your baseline
   - Design transfer functions to look correct at balanced quality
   - They will now automatically work correctly at all other presets

2. **Test at multiple presets**
   ```python
   # Design at balanced
   config = RenderConfig.balanced()
   renderer.set_config(config)
   # ... adjust transfer functions until it looks good ...

   # Verify at other presets - should look the same
   renderer.set_config(RenderConfig.preview())  # Should look same, just rougher
   renderer.set_config(RenderConfig.ultra_quality())  # Should look same, just smoother
   ```

3. **Adjust reference_step_size for special cases**
   - Only needed for very feature-dense or very simple volumes
   - Most users can use default reference_step_size = 0.01

### For Feature-Dense Volumes

Medical scans, turbulence simulations, high-frequency data:

```python
config = RenderConfig.balanced()
config.reference_step_size = 0.005  # Smaller for dense features
```

### For Simple Volumes

Synthetic datasets, smooth fields, low-frequency data:

```python
config = RenderConfig.balanced()
config.reference_step_size = 0.015  # Larger for simple volumes
```

## Usage Examples

### Basic Usage (No Changes Required)

```python
from pyvr.moderngl_renderer import VolumeRenderer
from pyvr.config import RenderConfig

# Existing code works unchanged - uses default reference_step_size=0.01
config = RenderConfig.high_quality()
renderer = VolumeRenderer(config=config)
```

### Custom reference_step_size

```python
from pyvr.config import RenderConfig

# For feature-dense medical data
config = RenderConfig.balanced()
config = RenderConfig(
    step_size=config.step_size,
    max_steps=config.max_steps,
    reference_step_size=0.005  # Smaller reference for dense features
)

# For simple synthetic volumes
config = RenderConfig.fast()
config = RenderConfig(
    step_size=config.step_size,
    max_steps=config.max_steps,
    reference_step_size=0.02  # Larger reference for simple volumes
)
```

### Switching Presets with Consistent Appearance

```python
# Now works correctly - all presets produce same appearance
renderer = VolumeRenderer(width=512, height=512)
renderer.load_volume(volume)
renderer.set_transfer_functions(ctf, otf)

# Fast preview during interaction
renderer.set_config(RenderConfig.fast())
preview = renderer.render()

# High quality for final output - looks the same, just smoother
renderer.set_config(RenderConfig.ultra_quality())
final = renderer.render()

# Both have same overall opacity/brightness, different sampling smoothness
```

## Technical Details

### Beer-Lambert Law Implementation

The opacity correction implements the Beer-Lambert law for light absorption:

```
Transmittance = exp(-extinction_coefficient * distance)
Opacity = 1 - Transmittance
```

In our shader:
```glsl
float extinction = alpha_tf / reference_step_size;
float distance = step_size;
float transmittance = exp(-extinction * distance);
float opacity = 1.0 - transmittance;

// Simplified:
float opacity = 1.0 - exp(-alpha_tf * step_size / reference_step_size);
```

### Why This Is Physically Correct

1. **Exponential attenuation:** Light absorption follows exponential decay, not linear
2. **Distance scaling:** Longer steps should accumulate more opacity
3. **Reference independence:** Final result shouldn't depend on sampling resolution
4. **Industry standard:** Matches VTK, ParaView, OSPRay implementations

### Verification of Correctness

The implementation has been verified through:
- Mathematical unit tests confirming Beer-Lambert law
- Physical consistency tests (two small steps â‰ˆ one large step)
- Visual comparison across all presets showing consistency
- Edge case testing (alpha=0, alpha=1, extreme step sizes)

## Benefits

1. **Physical Correctness:** Implements industry-standard Beer-Lambert law
2. **Preset Consistency:** All quality presets produce same appearance
3. **Scientific Validity:** Results are reproducible and physically meaningful
4. **Proper Preset Usage:** Presets can be used as intended (speed vs quality, not appearance)
5. **Industry Compatibility:** Matches behavior of VTK, ParaView, OSPRay
6. **User Flexibility:** `reference_step_size` allows per-dataset tuning
7. **Pre-1.0 Fix:** Critical bug fixed before v1.0 API stabilization

## Known Issues

None.

## Backward Compatibility

**Breaking Change:** Yes - visual appearance changes at non-balanced presets

**API Compatibility:** Yes - all existing code works (uses default `reference_step_size`)

**Data Compatibility:** Yes - no changes to volume data or file formats

**Migration Effort:** Low - adjust transfer functions or `reference_step_size` if needed

## References

- Beer-Lambert Law: https://en.wikipedia.org/wiki/Beer%E2%80%93Lambert_law
- VTK Volume Rendering: https://vtk.org/doc/nightly/html/classvtkVolumeProperty.html
- OSPRay Transfer Functions: https://www.ospray.org/documentation.html

## Testing

All 398 tests pass, including:
- 20+ unit tests for opacity correction formula
- 10+ integration tests for rendering pipeline
- Visual comparison validation across all presets
- Regression tests confirming no breakage
- Edge case coverage (alpha=0, alpha=1, extreme values)

**Coverage:** >90% for new code

## Contributors

- Jixian Li (bug report and design collaboration)
- Claude Code (implementation)

## Acknowledgments

Thank you to Jixian for identifying this critical bug and providing excellent insight into the physical basis for the correction.
```

**Verification:** Review version notes for completeness, clarity, and accuracy.

### Task 2: Update README.md

**File:** `README.md`

**Changes:**

Find the RenderConfig section (around line 280-345) and add a subsection about opacity correction:

**Add after the "Custom Configuration" subsection:**

```markdown
### Opacity Correction

PyVR implements Beer-Lambert law for physically correct opacity accumulation (v0.3.3+). This ensures all quality presets produce consistent visual appearance.

**How It Works:**

Transfer functions define opacity at a reference step size. When rendering at different step sizes, opacity is automatically corrected:

```python
# Formula: alpha_corrected = 1.0 - exp(-alpha_tf * step_size / reference_step_size)
```

**Default Behavior:**

```python
# All presets use reference_step_size=0.01 by default
# This means transfer functions are designed for "balanced" quality
config = RenderConfig.high_quality()  # Works correctly, looks same as balanced
```

**Customizing for Your Data:**

```python
# Feature-dense volumes (medical, turbulence): use smaller reference
config = RenderConfig(
    step_size=0.01,
    max_steps=500,
    reference_step_size=0.005  # Denser sampling reference
)

# Simple volumes (synthetic, smooth): use larger reference
config = RenderConfig(
    step_size=0.01,
    max_steps=500,
    reference_step_size=0.02  # Sparser sampling reference
)
```

**Benefits:**
- All presets produce same overall appearance
- Switch quality without changing how it looks
- Physically accurate (Beer-Lambert law)
- Industry standard (matches VTK, ParaView)
```

**Verification:** Ensure formatting is consistent with rest of README.

### Task 3: Update CLAUDE.md

**File:** `CLAUDE.md`

**Changes:**

Find the version history section (around line 227) and add v0.3.3 entry:

**Add before v0.3.2 entry:**

```markdown
**v0.3.3** (2025-XX-XX): Ray marching opacity consistency (Bug Fix)
- Fix: Implement Beer-Lambert law for physically correct opacity accumulation
- Change: Add reference_step_size parameter to RenderConfig (default: 0.01)
- Change: Modify fragment shader to apply exponential opacity correction
- Breaking: Visual appearance changes at non-balanced presets (high quality lighter, low quality darker)
- Impact: All quality presets now produce consistent appearance (physically correct)
- Formula: `alpha = 1.0 - exp(-alpha_tf * step_size / reference_step_size)`
- Tests: 368 â†’ 398 tests (all passing)
- See: `version_notes/v0.3.3_ray_marching_consistency.md` for migration guide
```

Also update the test count in the badge at the top of README.md:

```markdown
[![Tests](https://img.shields.io/badge/tests-398%20passing-brightgreen.svg)](#-testing)
```

**Verification:** Ensure version notes are consistent with other entries.

### Task 4: Update Test Count in Documentation

**Files to update:**

1. **README.md** (top badge, around line 6):
```markdown
[![Tests](https://img.shields.io/badge/tests-398%20passing-brightgreen.svg)](#-testing)
```

2. **README.md** (testing section, around line 549):
```markdown
# Run all tests (398 tests)
pytest tests/
```

3. **README.md** (test coverage breakdown, around line 577):
```markdown
ðŸ“ˆ Total                     398       ~88%
```

4. **CLAUDE.md** (test count in overview, around line 26):
```markdown
- **âœ… Comprehensive Testing**: 398 tests with 88%+ coverage
```

**Verification:** Search for "368" and replace with "398" in documentation.

### Task 5: Verify RenderConfig Docstring

**File:** `pyvr/config.py`

**Action:** Verify the `reference_step_size` docstring added in Phase 01 is complete and matches version notes.

**Expected docstring:**
```python
reference_step_size: float = 0.01
    """Reference step size for opacity correction.

    Transfer functions define opacity at this reference step size.
    When rendering at different step sizes, opacity is corrected
    using Beer-Lambert law to maintain physical consistency.

    Guidelines:
    - Feature-dense volumes (medical, turbulence): 0.005-0.008
    - Simple volumes (synthetic, smooth fields): 0.015-0.02
    - Default (0.01): Matches balanced preset, good for most cases

    The same transfer function will produce identical appearance
    across all quality presets when reference_step_size is set correctly.

    Physical basis:
        alpha_corrected = 1.0 - exp(-alpha_tf * step_size / reference_step_size)

    This implements Beer-Lambert law for light absorption through a medium.
    """
```

**Verification:** Docstring is clear, complete, and matches documentation.

## Verification Steps

### Step 1: Verify Version Notes

```bash
# Check version notes exist and are complete
cat version_notes/v0.3.3_ray_marching_consistency.md | head -20

# Should show complete header and overview
```

### Step 2: Verify README Updates

```bash
# Check README has opacity correction section
grep -A 10 "Opacity Correction" README.md

# Check test count updated
grep "398" README.md

# Should show multiple occurrences
```

### Step 3: Verify CLAUDE.md Updates

```bash
# Check v0.3.3 entry exists
grep -A 8 "v0.3.3" CLAUDE.md

# Should show complete version entry
```

### Step 4: Verify All Documentation Consistent

```bash
# Check that all test counts are updated
grep -r "368 test" . --include="*.md"

# Should return no results (all updated to 398)

grep -r "398 test" . --include="*.md"

# Should show multiple files
```

### Step 5: Review Complete Documentation

Manual review checklist:
- [ ] Version notes are comprehensive and clear
- [ ] Migration guide is helpful and actionable
- [ ] README.md opacity correction section is clear
- [ ] CLAUDE.md version entry is accurate
- [ ] All test counts updated (398 not 368)
- [ ] Docstrings are complete and consistent
- [ ] Breaking changes are well-documented
- [ ] Examples are correct and tested

## Validation

### Documentation Quality Check

**Completeness:**
- [ ] Problem statement clearly explained
- [ ] Technical solution described with formulas
- [ ] Breaking changes documented with examples
- [ ] Migration guide provides clear paths
- [ ] Benefits and rationale explained
- [ ] References to industry standards included

**Clarity:**
- [ ] Non-technical users can understand the impact
- [ ] Technical users can understand the implementation
- [ ] Migration steps are actionable
- [ ] Examples are complete and runnable

**Consistency:**
- [ ] Version notes match implementation
- [ ] README matches version notes
- [ ] CLAUDE.md matches version notes
- [ ] All test counts consistent (398)
- [ ] All references to v0.3.3 consistent

### User-Facing Documentation Test

Create a test to verify examples in documentation:

```python
# Test all code examples from version notes and README
# Run each example and verify it works

from pyvr.moderngl_renderer import VolumeRenderer
from pyvr.config import RenderConfig
from pyvr.volume import Volume
from pyvr.datasets import create_sample_volume

# Example from version notes: basic usage
config = RenderConfig.high_quality()
renderer = VolumeRenderer(config=config)
assert renderer.get_config().reference_step_size == 0.01

# Example from version notes: custom reference
config = RenderConfig(
    step_size=0.01,
    max_steps=500,
    reference_step_size=0.005
)
assert config.reference_step_size == 0.005

# Example from README: feature-dense volumes
config = RenderConfig(
    step_size=0.01,
    max_steps=500,
    reference_step_size=0.005
)
renderer = VolumeRenderer(config=config, width=128, height=128)
volume_data = create_sample_volume(64, 'sphere')
volume = Volume(data=volume_data)
renderer.load_volume(volume)
data = renderer.render()
assert data is not None

print("âœ“ All documentation examples work correctly")
```

## Acceptance Criteria

- [ ] Version notes created: `version_notes/v0.3.3_ray_marching_consistency.md`
- [ ] Version notes are comprehensive (problem, solution, migration, examples)
- [ ] README.md updated with opacity correction section
- [ ] README.md test counts updated to 398
- [ ] CLAUDE.md updated with v0.3.3 version entry
- [ ] CLAUDE.md test counts updated to 398
- [ ] All test counts in documentation updated (368 â†’ 398)
- [ ] RenderConfig docstring verified complete
- [ ] Breaking changes clearly documented
- [ ] Migration guide is actionable and helpful
- [ ] All code examples in documentation are correct and tested
- [ ] Documentation is consistent across all files
- [ ] References to industry standards included
- [ ] Documentation reviewed for clarity and completeness

## Git Commit

**When all acceptance criteria are met**, commit with:

```bash
git add version_notes/v0.3.3_ray_marching_consistency.md \
        README.md \
        CLAUDE.md

git commit -m "$(cat <<'EOF'
docs(v0.3.3): Add comprehensive documentation for opacity correction

Complete documentation for v0.3.3 ray marching opacity consistency:

Version notes (v0.3.3_ray_marching_consistency.md):
- Comprehensive explanation of the bug and fix
- Technical details of Beer-Lambert law implementation
- Breaking visual changes documented with examples
- Migration guide for affected users (adjust TF or reference_step_size)
- Usage examples and guidelines for different volume types

README.md updates:
- New "Opacity Correction" subsection in RenderConfig section
- Explanation of reference_step_size parameter
- Guidelines for feature-dense vs simple volumes
- Update test count: 368 â†’ 398

CLAUDE.md updates:
- v0.3.3 version history entry
- Breaking changes noted
- Reference to migration guide
- Update test count: 368 â†’ 398

All documentation is consistent, complete, and user-friendly.
Migration paths clearly explained for users affected by visual changes.

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
```

## Release Checklist

Before merging to main and releasing v0.3.3:

- [ ] All Phase 01 acceptance criteria met
- [ ] All Phase 02 acceptance criteria met
- [ ] All Phase 03 acceptance criteria met
- [ ] All 398 tests passing
- [ ] Visual comparison confirms opacity consistency
- [ ] Documentation complete and reviewed
- [ ] Breaking changes clearly communicated
- [ ] Migration guide tested with real examples
- [ ] Examples in documentation all work
- [ ] Version number updated in appropriate files
- [ ] Release notes finalized

## Notes

This completes the v0.3.3 ray marching opacity consistency feature. The implementation:

1. **Fixes a critical bug** where quality presets produced inconsistent results
2. **Implements industry-standard physics** (Beer-Lambert law)
3. **Maintains backward compatibility** (API-wise, with visual breaking change)
4. **Is thoroughly tested** (30+ new tests, all passing)
5. **Is well-documented** (comprehensive version notes and migration guide)

The feature is ready for release once all phase acceptance criteria are met and the release checklist is complete.
