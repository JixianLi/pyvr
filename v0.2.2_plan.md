# PyVR v0.2.2 Development Plan

## 🎯 Overview
Version 0.2.2 focuses on two major improvements:
1. **RGBA Texture Combination**: Merge color and opacity transfer functions into a single RGBA texture
2. **Enhanced Test Coverage**: Add comprehensive unit tests for manager and renderer components

## 🏗️ Feature 1: RGBA Transfer Function Texture

### **Motivation**
Currently we create separate textures for color (RGB) and opacity (A), requiring two texture lookups in shaders:
```glsl
float alpha = texture(opacity_lut, vec2(density, 0.5)).r;
vec3 rgb = texture(color_lut, vec2(density, 0.5)).rgb;
```

**Benefits of RGBA Combination:**
- **Performance**: Single texture lookup instead of two
- **Simplicity**: One texture binding instead of two
- **Efficiency**: Better cache locality and reduced texture units
- **Standard Practice**: RGBA transfer functions are industry standard

### **API Design**

#### **New ModernGLManager Method**
```python
def create_rgba_transfer_function_texture(self, 
                                        color_transfer_function: ColorTransferFunction,
                                        opacity_transfer_function: OpacityTransferFunction, 
                                        size: Optional[int] = None) -> int:
    """
    Create a combined RGBA texture from color and opacity transfer functions.
    
    Args:
        color_transfer_function: ColorTransferFunction instance for RGB channels
        opacity_transfer_function: OpacityTransferFunction instance for A channel
        size: Optional LUT size (uses max of both TFs if not specified)
        
    Returns:
        Texture unit (int) for use in shaders
    """
```

#### **Usage Example**
```python
# OLD v0.2.1 (two separate textures) ❌
opacity_tex_unit = renderer.gl_manager.create_opacity_transfer_function_texture(otf)
renderer.gl_manager.set_uniform_int('opacity_lut', opacity_tex_unit)

color_tex_unit = renderer.gl_manager.create_color_transfer_function_texture(ctf)
renderer.gl_manager.set_uniform_int('color_lut', color_tex_unit)

# NEW v0.2.2 (single RGBA texture) ✅
rgba_tex_unit = renderer.gl_manager.create_rgba_transfer_function_texture(ctf, otf)
renderer.gl_manager.set_uniform_int('transfer_function_lut', rgba_tex_unit)
```

### **Implementation Plan**

#### **Step 1: ModernGLManager Enhancement**
- Add `create_rgba_transfer_function_texture()` method
- Combine RGB LUT from ColorTransferFunction with A LUT from OpacityTransferFunction
- Handle size mismatches by using maximum size and interpolating
- Create 4-channel (RGBA) texture

#### **Step 2: Shader Updates**
- Update `volume.frag.glsl` to use single RGBA texture lookup
- Replace separate `opacity_lut` and `color_lut` uniforms with `transfer_function_lut`
- Maintain backward compatibility through conditional compilation or separate shader versions

#### **Step 3: Renderer Integration**
- Add convenience method to VolumeRenderer for easy RGBA texture setup
- Update examples to demonstrate new API
- Maintain backward compatibility for separate texture methods

#### **Step 4: Validation & Testing**
- Ensure visual output identical between separate and combined approaches
- Performance benchmarking to validate improvements
- Edge case testing (different sizes, extreme values)

### **Backward Compatibility Strategy**
- Keep existing separate texture methods functional
- Add deprecation warnings for v0.3.0 removal
- Provide migration guide in documentation

---

## 🧪 Feature 2: Enhanced Test Coverage

### **Current Test Coverage Analysis**
Based on examination, we have **49 tests** covering:
- ✅ **Camera System**: Comprehensive (24 tests)
- ✅ **Transfer Functions**: Comprehensive (22 tests) 
- ✅ **Shader Loading**: Basic (3 tests)
- ❌ **ModernGLManager**: No unit tests
- ❌ **VolumeRenderer**: No unit tests

### **Test Coverage Goals**

#### **ModernGLManager Test Suite**
**File**: `tests/test_moderngl_renderer/test_manager.py`

**Test Categories:**
1. **Initialization Tests**
   - Context creation
   - Framebuffer setup
   - Resource initialization
   - Dimension validation

2. **Texture Creation Tests**
   - `create_volume_texture()` with various shapes and data types
   - `create_normal_texture()` with valid/invalid dimensions
   - `create_lut_texture()` with 1-channel and 3-channel data
   - `create_color_transfer_function_texture()` integration
   - `create_opacity_transfer_function_texture()` integration
   - **NEW**: `create_rgba_transfer_function_texture()` comprehensive testing

3. **Shader Management Tests**
   - `load_shaders()` with valid files
   - Error handling for missing/invalid shader files
   - Shader compilation error handling

4. **Uniform Setting Tests**
   - Matrix, vector, float, int uniform setting
   - Error cases (shader not loaded)
   - Type validation

5. **Resource Management Tests**
   - Texture unit allocation tracking
   - Cleanup functionality
   - Memory leak prevention

#### **VolumeRenderer Test Suite**
**File**: `tests/test_moderngl_renderer/test_renderer.py`

**Test Categories:**
1. **Initialization Tests**
   - Constructor parameter validation
   - Default value verification
   - ModernGLManager integration

2. **Volume Loading Tests**
   - `load_volume()` with various volume shapes
   - `load_normal_volume()` validation
   - Error handling for invalid data

3. **Camera Setup Tests**
   - `set_camera()` with various positions/orientations
   - Matrix calculation verification
   - Edge case handling

4. **Rendering Parameter Tests**
   - `set_step_size()`, `set_max_steps()` validation
   - Lighting parameter setting
   - Volume bounds configuration

5. **Integration Tests**
   - End-to-end rendering without OpenGL (mock testing)
   - Transfer function integration
   - Error state recovery

#### **Mock Testing Strategy**
Since OpenGL context creation can be problematic in CI environments:
- Use `unittest.mock` to mock ModernGL calls
- Test logic and parameter validation without actual OpenGL
- Separate "integration tests" that require actual OpenGL context
- Use pytest fixtures for test organization

### **Test Implementation Plan**

#### **Step 1: Mock Framework Setup**
```python
# tests/test_moderngl_renderer/conftest.py
import pytest
from unittest.mock import MagicMock, patch

@pytest.fixture
def mock_moderngl():
    with patch('moderngl.create_context') as mock_ctx:
        # Setup comprehensive mock for ModernGL
        yield mock_ctx
```

#### **Step 2: ModernGLManager Tests**
- Start with initialization and basic functionality
- Add texture creation tests with mocked OpenGL calls
- Test error handling and edge cases
- Target: 25+ tests for comprehensive coverage

#### **Step 3: VolumeRenderer Tests**
- Test high-level interface without OpenGL dependency
- Validate parameter passing to ModernGLManager
- Test rendering pipeline logic
- Target: 20+ tests for comprehensive coverage

#### **Step 4: Integration Tests**
- Optional tests that run with actual OpenGL context
- Visual regression testing
- Performance benchmarking
- Target: 10+ integration tests

---

## 📋 Implementation Timeline

### **Phase 1: RGBA Texture Implementation (Week 1)**
1. ✅ Plan creation and design finalization
2. 🔲 Implement `create_rgba_transfer_function_texture()` in ModernGLManager
3. 🔲 Update shader to support RGBA lookup
4. 🔲 Add VolumeRenderer convenience method
5. 🔲 Update one example to demonstrate new API

### **Phase 2: Testing Framework (Week 2)**
1. 🔲 Setup mock testing framework
2. 🔲 Implement ModernGLManager unit tests (25+ tests)
3. 🔲 Implement VolumeRenderer unit tests (20+ tests)
4. 🔲 Add integration tests (10+ tests)
5. 🔲 Verify test coverage improvement (target: 80+ total tests)

### **Phase 3: Documentation and Polish (Week 3)**
1. 🔲 Update all examples to use RGBA texture method
2. 🔲 Create migration guide for v0.2.1 → v0.2.2
3. 🔲 Add performance comparison documentation
4. 🔲 Update README with new capabilities
5. 🔲 Prepare release notes

---

## 🎯 Success Metrics

### **Feature Metrics**
- ✅ RGBA texture method implemented and working
- ✅ Visual output identical to separate texture approach
- ✅ Performance improvement measurable (target: 10-20% faster)
- ✅ All existing functionality preserved

### **Testing Metrics**
- ✅ Test count increase from 49 to 80+ tests
- ✅ Manager and renderer coverage > 90%
- ✅ All tests pass consistently
- ✅ CI/CD pipeline enhanced with comprehensive testing

### **Quality Metrics**
- ✅ Backward compatibility maintained
- ✅ Clear migration documentation
- ✅ No breaking API changes
- ✅ Comprehensive error handling

---

## 🚀 Getting Started

The first step is to implement the RGBA texture functionality. This involves:

1. **Examining Current LUT Generation**: Understanding how ColorTransferFunction and OpacityTransferFunction generate their LUTs
2. **Implementing RGBA Combination**: Creating the new ModernGLManager method
3. **Shader Updates**: Modifying the fragment shader for single texture lookup
4. **Testing**: Ensuring visual output matches existing approach

Would you like to proceed with Phase 1 implementation?