# PyVR v0.3.1 - Interface Refinements

**Release Date**: 2025-10-31
**Type**: Feature Release (Backward Compatible)

## Overview

PyVR v0.3.1 enhances the interactive interface (introduced in v0.3.0) with four key refinements focused on usability and performance monitoring:

1. **FPS Counter**: Real-time frames-per-second display
2. **Quality Preset Selector**: Switch between 5 rendering quality levels
3. **Camera-Linked Lighting**: Lights follow camera movement
4. **Histogram Background**: Data distribution visualization in opacity editor

All features add <1% overhead and are fully backward compatible with v0.3.0.

## New Features

### 1. FPS Counter (Phase 1)

Real-time performance monitoring with rolling average.

**Usage:**
```python
interface = InteractiveVolumeRenderer(volume=volume)
interface.state.show_fps = True  # Enabled by default

# Toggle with 'f' key during interaction
interface.show()
```

**Features:**
- Rolling 30-frame average for stable display
- Green text in top-left corner
- Microsecond precision timing
- <1% performance overhead

### 2. Quality Preset Selector (Phase 2)

Interactive widget for switching rendering quality.

**Presets Available:**
- `preview`: Extremely fast (~50 samples/ray)
- `fast`: Interactive quality (~86 samples/ray)
- `balanced`: Default quality (~173 samples/ray)
- `high_quality`: Publication quality (~346 samples/ray)
- `ultra_quality`: Maximum quality (~1732 samples/ray)

**Usage:**
```python
# Interface includes preset selector by default
interface.show()

# Programmatic control
interface._on_preset_change('high_quality')

# Convenience method
interface.set_high_quality_mode()
```

### 3. Camera-Linked Lighting (Phase 3)

Directional lights automatically follow camera with configurable offsets.

**Usage:**
```python
from pyvr.lighting import Light

# Method 1: Using preset
light = Light.camera_linked(
    azimuth_offset=np.pi/4,  # 45Â° horizontal offset
    elevation_offset=0.0
)

# Method 2: Link existing light
light = Light.directional([1, -1, 0])
light.link_to_camera(azimuth_offset=0.0, elevation_offset=0.2)

# Update each frame (interface does this automatically)
light.update_from_camera(camera)
renderer.set_light(light)

# In interface
interface.set_camera_linked_lighting(azimuth_offset=np.pi/4)
# Or toggle with 'l' key
```

**Features:**
- Maintains consistent illumination during orbit
- Configurable angular offsets
- <1% performance overhead
- Toggle on/off with 'l' key

### 4. Log-Scale Histogram Background (Phase 4)

Opacity editor shows data distribution for guided control point placement.

**Usage:**
```python
# Histogram loaded automatically on interface creation
interface = InteractiveVolumeRenderer(volume=volume)
interface.show()  # Histogram visible by default

# Toggle with 'h' key

# Programmatic control
interface.state.show_histogram = False
```

**Features:**
- Log-scale visualization (makes all ranges visible)
- Persistent caching in `tmp_dev/histogram_cache/`
- Cache speedup >5x (100ms â†’ <10ms)
- Subtle blue-gray coloring (doesn't interfere with UI)

### 5. Integration Features (Phase 5)

Additional polish for cohesive experience:

**Status Display:**
Shows current settings (preset, FPS, histogram, light linking)

**Automatic Quality Switching:**
```python
# Enabled by default
interface.state.auto_quality_enabled = True

# Automatically switches to 'fast' during camera drag
# Restores original quality after interaction completes

# Toggle with 'q' key
```

**Convenience Methods:**
```python
# High quality mode
interface.set_high_quality_mode()

# Camera-linked lighting setup
interface.set_camera_linked_lighting(azimuth_offset=np.pi/4)

# Capture ultra-quality screenshot
path = interface.capture_high_quality_image("render.png")
```

## API Changes

### New Classes

**`pyvr.interface.widgets.FPSCounter`**: FPS calculation with rolling average
**`pyvr.interface.widgets.PresetSelector`**: Quality preset selector widget

### New Module

**`pyvr.interface.cache`**: Histogram caching utilities
- `get_or_compute_histogram(volume_data)` - Main entry point
- `compute_volume_hash(volume_data)` - Hash generation
- `clear_histogram_cache()` - Cache management

### Extended Classes

**`pyvr.lighting.Light`**:
- `link_to_camera(azimuth_offset, elevation_offset, distance_offset)` - Enable linking
- `unlink_from_camera()` - Disable linking
- `update_from_camera(camera)` - Update position from camera
- `is_linked` property - Check link status
- `get_offsets()` - Get current offsets
- `Light.camera_linked()` class method - Create pre-linked light

**`pyvr.interface.widgets.ImageDisplay`**:
- `__init__(ax, show_fps=True)` - FPS counter support
- `set_fps_visible(visible)` - Toggle FPS display

**`pyvr.interface.widgets.OpacityEditor`**:
- `__init__(ax, show_histogram=True)` - Histogram support
- `set_histogram(bin_edges, log_counts)` - Set histogram data
- `set_histogram_visible(visible)` - Toggle histogram display

**`pyvr.interface.state.InterfaceState`**:
- `show_fps: bool` - FPS counter visibility
- `show_histogram: bool` - Histogram visibility
- `current_preset_name: str` - Active quality preset
- `light_linked_to_camera: bool` - Light linking state
- `auto_quality_enabled: bool` - Auto-quality switching
- `set_preset(preset_name)` - Set rendering preset

**`pyvr.interface.matplotlib_interface.InteractiveVolumeRenderer`**:
- `set_high_quality_mode()` - Convenience for HQ rendering
- `set_camera_linked_lighting(offsets)` - Easy light setup
- `capture_high_quality_image(filename)` - Ultra-quality screenshots

## Keyboard Shortcuts

v0.3.1 adds 4 new keyboard shortcuts:

| Key | Action | New in v0.3.1 |
|-----|--------|---------------|
| `f` | Toggle FPS counter | âœ… |
| `h` | Toggle histogram | âœ… |
| `l` | Toggle light linking | âœ… |
| `q` | Toggle auto-quality | âœ… |
| `r` | Reset view | (existing) |
| `s` | Save image | (existing) |
| `Esc` | Deselect | (existing) |
| `Del` | Delete selected | (existing) |

## Migration Guide

**v0.3.0 â†’ v0.3.1**: No changes required! All v0.3.0 code works unchanged.

All new features are:
- **Additive** (no API changes)
- **Opt-in** (can be disabled if desired)
- **Backward compatible** (v0.3.0 code runs unchanged)

### Optional: Adopt New Features

```python
# v0.3.0 code (still works)
interface = InteractiveVolumeRenderer(volume=volume)
interface.show()

# v0.3.1 enhancements (optional)
interface = InteractiveVolumeRenderer(volume=volume)
interface.state.show_fps = True  # Default: True
interface.state.show_histogram = True  # Default: True
interface.set_camera_linked_lighting()  # Optional
interface.show()
```

## Performance

All new features designed for minimal overhead:

| Feature | Overhead | Metric |
|---------|----------|--------|
| FPS Counter | <1% | Per-frame timing |
| Preset Selector | 0% | Only on preset change |
| Light Linking | <1% | Matrix math per frame |
| Histogram (cached) | 0% | One-time computation |
| Auto-Quality | 0% | Only during interaction |

**Histogram Performance:**
- First computation: ~50-100ms (128Â³ volume)
- Cached loading: <10ms
- Speedup: >5x

## Testing

**Test Coverage:**
- New tests: +77 tests
- Total tests: 361 passing (from 284)
- Coverage: >90% for interface module
- Coverage: ~86% overall (maintained)

**Test Categories:**
- Unit tests: FPS counter, preset selector, light linking, histogram
- Integration tests: Feature interactions
- Bug fix tests: Phase 5.5 critical bug fixes
- Regression tests: All v0.3.0 tests pass

## Breaking Changes

**None** - This is a fully backward compatible release.

## Bug Fixes (Phase 5.5)

Five critical bugs were fixed before release:

1. **Status Display Overlay**: Combined info display into single text block
2. **Light Linking Errors**: Added error handling and automatic unlinking on failures
3. **Mouse Event Handlers**: Verified all event handlers properly connected
4. **Matplotlib Keybinding Conflicts**: Disabled all default matplotlib key bindings
5. **Auto-Quality Rendering**: Enable rendering during mouse drag for responsive interaction

All bugs tested with 8 new tests in `test_bug_fixes.py`.

## Known Issues

None

## Future Enhancements

Potential features for v0.3.2+:
- Preset auto-selection based on FPS
- Save/load interface configurations
- Recording camera path animations
- Multiple histogram visualizations (linear, sqrt, log)
- Control point placement guided by histogram peaks

## Contributors

- Claude Code (AI Assistant)
- [Project maintainers]

## Release Checklist

- [x] All features implemented (Phases 1-5)
- [x] All bugs fixed (Phase 5.5)
- [x] All tests passing (361 tests)
- [x] Documentation updated (README, CLAUDE.md, version notes)
- [x] Examples created (v031_features_demo.py)
- [x] Coverage >90% for new code
- [x] Performance validated (<1% overhead)
- [x] No breaking changes
- [x] Backward compatibility verified

## Full Feature List

**Phase 1 - FPS Counter:**
- `FPSCounter` class with rolling average
- `ImageDisplay.set_fps_visible()` method
- 14 unit tests

**Phase 2 - Preset Selector:**
- `PresetSelector` widget class
- 5 quality presets with radio buttons
- `_on_preset_change()` callback integration
- 13 unit tests

**Phase 3 - Camera-Linked Lighting:**
- `Light.link_to_camera()` method
- `Light.update_from_camera()` method
- `Light.camera_linked()` preset
- 20 unit tests + integration tests

**Phase 4 - Histogram Background:**
- `pyvr.interface.cache` module
- Histogram caching with SHA256 hashing
- Log-scale visualization
- `OpacityEditor.set_histogram()` method
- 18 unit tests

**Phase 5 - Integration:**
- Status display with dynamic updates
- Automatic quality switching
- Convenience methods
- 10 integration tests

**Phase 5.5 - Bug Fixes:**
- Fixed status display overlay
- Fixed light linking errors
- Fixed matplotlib keybinding conflicts
- Fixed mouse event handlers
- Fixed auto-quality rendering
- 8 bug fix tests

**Total New Tests:** +77 (284 â†’ 361)

---

**PyVR v0.3.1** - Enhanced Interactive Volume Rendering! ðŸš€
