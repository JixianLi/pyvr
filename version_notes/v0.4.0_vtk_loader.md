# PyVR v0.4.0 - VTK Data Loader (Development)

**Status:** Development (Feature Branch)
**Branch:** `feature/v0.4.0-vtk-loader`
**Type:** New feature addition

## Overview

This document describes the VTK data loader feature currently in development on the `feature/v0.4.0-vtk-loader` branch. This feature adds support for loading scientific volume data from VTK ImageData (.vti) files through the new `pyvr.dataloaders` module, enabling PyVR to work with real scientific datasets while maintaining its backend-agnostic architecture.

**Note:** This is development documentation. The feature will be officially released as v0.4.0 when merged to main.

## New Features

### VTK Data Loader

**New Module:** `pyvr.dataloaders`

The new data loaders module provides `load_vtk_volume()` for loading VTK ImageData files:

```python
from pyvr.dataloaders import load_vtk_volume

# Load VTK file - returns render-ready Volume
volume = load_vtk_volume("example_data/hydrogen.vti")

# Volume is automatically normalized and configured
from pyvr.interface import InteractiveVolumeRenderer
interface = InteractiveVolumeRenderer(volume)
interface.show()
```

**Key Features:**
- Automatic normalization to [0, 1] range
- Physical space-aware bounds calculation
- Aspect ratio preservation from VTK spacing
- Centered at [0, 0, 0] in world space
- Automatic normal vector computation
- Support for both string and `pathlib.Path` objects
- Comprehensive validation with descriptive error messages

**API:**
```python
def load_vtk_volume(file_path, scalars_name='Scalars_') -> Volume
```

**Parameters:**
- `file_path`: Path to .vti file (str or pathlib.Path)
- `scalars_name`: Name of scalar array to load (default: 'Scalars_')

**Returns:** `Volume` object ready for rendering

**Raises:**
- `FileNotFoundError`: File doesn't exist
- `ValueError`: Invalid VTK data (multi-component, missing array, invalid dimensions/spacing)

### Physical Space Support

The VTK loader respects physical dimensions from VTK spacing metadata:

**Example:**
```python
# VTK file with:
#   - Dimensions: (100, 100, 100) voxels
#   - Spacing: (0.5, 1.0, 2.0) units/voxel
#   - Physical dimensions: (50, 100, 200) units

volume = load_vtk_volume("data.vti")

# Longest physical dimension (200) maps to [-1, 1]
# Other dimensions scale proportionally:
# Bounds: [[-0.25, -0.5, -1.0], [0.25, 0.5, 1.0]]
```

This preserves the true aspect ratio of scientific data.

## New Dependencies

**VTK Added as Core Dependency:**
- `vtk >= 9.0` is now required
- No longer optional - installed by default with PyVR

**Installation:**
```bash
pip install pyvr  # VTK included automatically
# or
poetry install    # VTK included
```

## New Example

**File:** `examples/vtk_loading_demo.py`

Demonstrates:
- Loading .vti files with `load_vtk_volume()`
- Inspecting loaded volume properties
- Rendering with `InteractiveVolumeRenderer`

**Usage:**
```bash
python examples/vtk_loading_demo.py
```

**Note:** Examples have been consolidated into the `examples/` directory (merged from `example/`).

## Test Data

Two VTK datasets are included in `example_data/` (tracked in git):
- `hydrogen.vti` - 128³ volume
- `fuel.vti` - 64³ volume

Additional example datasets are available via symlinks (not tracked).

## Implementation Details

### Module Structure
```
pyvr/dataloaders/
├── __init__.py          # Exports load_vtk_volume
└── vtk_loader.py        # VTK implementation
```

### Data Processing Pipeline

1. **File Loading**: `vtkXMLImageDataReader` reads .vti file
2. **Metadata Extraction**: Dimensions and spacing from VTK
3. **Validation**: Strict checks for file existence, array name, components, dimensions, spacing
4. **Data Extraction**: VTK array → numpy with proper Z,Y,X reshaping
5. **Normalization**: Convert to float32 and normalize to [0, 1]
6. **Bounds Calculation**: Physical dimensions → aspect-preserving bounds centered at origin
7. **Volume Creation**: Create `Volume` object with computed normals

### VTK Dimension Ordering

**Important:** VTK's internal data is stored in Z,Y,X order despite the API using X,Y,Z:
- `GetDimensions()` returns `(nx, ny, nz)` in X,Y,Z order
- `GetSpacing()` returns `(sx, sy, sz)` in X,Y,Z order
- Internal data must be reshaped as `(nz, ny, nx)` to match PyVR's convention

This is handled automatically by the loader.

## Breaking Changes

**None.** This is a pure addition - no existing APIs changed.

## Migration Guide

**No migration needed.** Existing code continues to work unchanged.

**To use VTK loading:**
```python
# Old: Using synthetic datasets
from pyvr.datasets import create_sample_volume
volume = create_sample_volume(128, 'sphere')

# New: Using VTK datasets
from pyvr.dataloaders import load_vtk_volume
volume = load_vtk_volume("example_data/hydrogen.vti")

# Rest of code works identically
renderer.load_volume(volume)
```

## Known Limitations

**Current Scope (v0.4.0):**
- Only VTK ImageData (.vti) files supported
- Only single-component scalar data supported
- No support for multi-component volumes (RGB, vector fields)
- No support for legacy .vtk format
- No support for structured/unstructured grids

**Future Enhancements (v0.4.x):**
- Performance optimization for large volumes
- Additional VTK format support
- Multi-component volume support
- Optional normalization control
- Progress callbacks for large files

## Testing

**New Test Suite:**
- 14 comprehensive tests in `tests/test_dataloaders/test_vtk_loader.py`
- >85% coverage for `pyvr.dataloaders` module
- Tests cover: loading, bounds, normalization, metadata, error handling, path handling

**Run Tests:**
```bash
pytest tests/test_dataloaders/ -v
pytest tests/test_dataloaders/ --cov=pyvr.dataloaders --cov-report=term-missing
```

## Documentation Updates

- **README:** New "Loading VTK Data" section with examples
- **Example:** `examples/vtk_loading_demo.py`
- **Docstrings:** Complete API documentation in `vtk_loader.py`
- **Version Notes:** This document

## Acknowledgments

This release adds a highly-requested feature for working with scientific volume data. The VTK loader maintains PyVR's philosophy of simple, clean APIs while providing the flexibility needed for real-world scientific visualization.

---

## Development Status

**Current Branch:** `feature/v0.4.0-vtk-loader`
**Base Version:** 0.3.4
**Target Version:** 0.4.0 (upon merge to main)

**Development Changes:**
- Consolidated examples: Merged `example/` into `examples/` directory
- All example scripts now in unified `examples/` location

**Next Steps:**
- Merge to main branch when ready
- Official v0.4.0 release
- v0.4.x stabilization and refinement releases
